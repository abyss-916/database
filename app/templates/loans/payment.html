{% extends "base.html" %}

{% block app_content %}
<div class="row">
    <div class="col-md-6 col-md-offset-3">
        <h1>贷款还款</h1>
        
        <div class="panel panel-warning">
            <div class="panel-body">
                <p><strong>贷款号码:</strong> {{ loan.loan_number }}</p>
                <p><strong>贷款金额:</strong> ¥{{ "%.2f"|format(loan.amount) }}</p>
                <p><strong>已还款金额:</strong> ¥{{ "%.2f"|format(total_paid) }}</p>
                <p><strong>剩余金额:</strong> ¥{{ "%.2f"|format(loan.amount - total_paid) }}</p>
            </div>
        </div>
        
        <form action="" method="post" novalidate>
            {{ form.hidden_tag() }}
            
            <div class="form-group">
                {{ form.savings_account_id.label }}
                {{ form.savings_account_id(class="form-control") }}
                {% for error in form.savings_account_id.errors %}
                <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>
            
            <div class="form-group">
                {{ form.payment_amount.label }}
                {{ form.payment_amount(class="form-control", placeholder="请输入还款金额") }}
                {% for error in form.payment_amount.errors %}
                <span class="text-danger">{{ error }}</span>
                {% endfor %}
                <div class="help-block">
                    建议还款金额: ¥{{ "%.2f"|format(loan.amount - total_paid) }}
                </div>
            </div>
            
            <div class="form-group">
                {{ form.description.label }}
                {{ form.description(class="form-control", placeholder="请输入还款描述（可选）") }}
                {% for error in form.description.errors %}
                <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>
            
            <div class="alert alert-info">
                <strong>注意事项：</strong>
                <ul>
                    <li>请确保还款账户有足够的余额</li>
                    <li>还款金额不能为负数</li>
                    <li>还款操作一旦完成，无法撤销</li>
                </ul>
            </div>
            
            <div class="form-group text-center">
                {{ form.submit(class="btn btn-primary btn-lg") }}
                <a href="{{ url_for('loans.detail', loan_id=loan.id) }}" class="btn btn-default btn-lg">取消</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// 可以添加一些客户端验证
$(document).ready(function() {
    // 当选择账户时，显示账户余额
    $('#savings_account_id').change(function() {
        const selectedText = $(this).find('option:selected').text();
        console.log('Selected account:', selectedText);
    });
    
    // 提交前的简单验证
    $('form').submit(function() {
        const amount = parseFloat($('#payment_amount').val());
        if (isNaN(amount) || amount <= 0) {
            alert('请输入有效的还款金额');
            return false;
        }
    });
});
</script>
{% endblock %}