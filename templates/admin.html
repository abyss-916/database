<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>é“¶è¡Œç®¡ç†ç³»ç»Ÿ - ç®¡ç†å‘˜</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 0; }
    .header { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-weight: bold; font-size: 20px; color: #2d3748; }
    .nav { display: flex; gap: 24px; }
    .nav a { text-decoration: none; color: #4a5568; font-weight: 500; padding: 8px 16px; border-radius: 6px; transition: all 0.2s; }
    .nav a:hover, .nav a.active { background: #ebf4ff; color: #4299e1; }
    .container { max-width: 1200px; margin: 24px auto; padding: 0 24px; }
    .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; }
    h2 { margin-top: 0; color: #2d3748; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e2e8f0; }
    th { background: #f7fafc; font-weight: 600; color: #4a5568; }
    .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #4299e1; color: white; }
    .btn-danger { background: #e53e3e; color: white; }
    .btn-success { background: #38a169; color: white; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .form-group { margin-bottom: 16px; }
    label { display: block; margin-bottom: 8px; font-weight: 500; color: #4a5568; }
    input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 10% auto; padding: 24px; border-radius: 8px; width: 80%; max-width: 500px; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: black; }
    .alert { padding: 12px; border-radius: 6px; margin: 16px 0; }
    .alert-success { background: #c6f6d5; color: #22543d; border: 1px solid #9ae6b4; }
    .alert-error { background: #fed7d7; color: #742a2a; border: 1px solid #feb2b2; }
    .hidden { display: none; }
    .fade-out {
      opacity: 0;
      transition: opacity 0.5s ease-out;
    }
  </style>
</style>
</head>
<body>
  <div class="header">
    <div class="logo">ğŸ¦ é“¶è¡Œç®¡ç†ç³»ç»Ÿ</div>
    <div class="nav">
      <a href="#" class="active" data-tab="dashboard">ä»ªè¡¨ç›˜</a>
      <a href="#" data-tab="branches">åˆ†è¡Œ</a>
      <a href="#" data-tab="employees">å‘˜å·¥</a>
      <a href="#" data-tab="dependents">å®¶å±</a>
      <a href="#" data-tab="customers">å®¢æˆ·</a>
      <a href="#" data-tab="accounts">è´¦æˆ·</a>
      <a href="#" data-tab="loans">è´·æ¬¾</a>
      <a href="#" data-tab="approval">å®¡æ‰¹</a>
      <a href="/login">é€€å‡º</a>
    </div>
  </div>
  
  <div class="container">
    <!-- ä»ªè¡¨ç›˜ -->
    <div id="dashboard" class="tab-content">
      <div class="card">
        <h2>ç³»ç»Ÿæ¦‚è§ˆ</h2>
        <div id="stats">
          <!-- ç»Ÿè®¡æ•°æ®å°†é€šè¿‡JSåŠ è½½ -->
          åŠ è½½ä¸­...
        </div>
      </div>
      <div class="card">
        <h2>å¿«æ·æŸ¥è¯¢</h2>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <a class="btn btn-primary" href="/admin/query/branch">æ”¯è¡ŒæŸ¥è¯¢</a>
          <a class="btn btn-primary" href="/admin/query/customer">å®¢æˆ·æŸ¥è¯¢</a>
          <a class="btn btn-primary" href="/admin/query/account">è´¦æˆ·æŸ¥è¯¢</a>
          <a class="btn btn-primary" href="/admin/query/employee">å‘˜å·¥æŸ¥è¯¢</a>
          <a class="btn btn-primary" href="/admin/query/loan">è´·æ¬¾æŸ¥è¯¢</a>
        </div>
      </div>
    </div>
    
    <!-- åˆ†è¡Œç®¡ç† -->
    <div id="branches" class="tab-content hidden">
      <div class="card">
        <h2>åˆ†è¡Œåˆ—è¡¨</h2>
        <table id="branches-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>è”è¡Œå·</th>
              <th>åç§°</th>
              <th>åŸå¸‚</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h2>æ·»åŠ åˆ†è¡Œ</h2>
        <form id="branch-form">
          <div class="form-group">
            <label>è”è¡Œå·</label>
            <input type="text" name="union_no" required>
          </div>
          <div class="form-group">
            <label>åç§°</label>
            <input type="text" name="name" required>
          </div>
          <div class="form-group">
            <label>åŸå¸‚</label>
            <input type="text" name="city" required>
          </div>
          <button type="submit" class="btn btn-primary">æ·»åŠ åˆ†è¡Œ</button>
        </form>
        <div id="branch-form-alert" class="alert hidden"></div>
        <div id="branch-alert" class="alert hidden"></div>
      </div>
    </div>
    
    <!-- å‘˜å·¥ç®¡ç† -->
    <div id="employees" class="tab-content hidden">
      <div class="card">
        <h2>å‘˜å·¥åˆ—è¡¨</h2>
        <table id="employees-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>å§“å</th>
              <th>ç”µè¯</th>
              <th>å…¥èŒæ—¥æœŸ</th>
              <th>ä¸Šçº§ID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h2>æ·»åŠ å‘˜å·¥</h2>
        <form id="employee-form">
          <div class="form-group">
            <label>å§“å</label>
            <input type="text" name="name" required>
          </div>
          <div class="form-group">
            <label>ç”µè¯</label>
            <input type="text" name="phone">
          </div>
          <div class="form-group">
            <label>å…¥èŒæ—¥æœŸ</label>
            <input type="date" name="hire_date" required>
          </div>
          <div class="form-group">
            <label>ä¸Šçº§ID</label>
            <input type="number" name="manager_id">
          </div>
          <button type="submit" class="btn btn-primary">æ·»åŠ å‘˜å·¥</button>
        </form>
        <div id="employee-form-alert" class="alert hidden"></div>
        <div id="employee-alert" class="alert hidden"></div>
      </div>
    </div>
    
    <!-- å®¶å±ç®¡ç† -->
    <div id="dependents" class="tab-content hidden">
      <div class="card">
        <h2>å®¶å±åˆ—è¡¨</h2>
        <table id="dependents-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>å‘˜å·¥ID</th>
              <th>å§“å</th>
              <th>å…³ç³»</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h2>æ·»åŠ å®¶å±</h2>
        <form id="dependent-form">
          <div class="form-group">
            <label>å‘˜å·¥ID</label>
            <input type="number" name="employee_id" required>
          </div>
          <div class="form-group">
            <label>å§“å</label>
            <input type="text" name="name" required>
          </div>
          <div class="form-group">
            <label>å…³ç³»</label>
            <input type="text" name="relationship" required>
          </div>
          <button type="submit" class="btn btn-primary">æ·»åŠ å®¶å±</button>
        </form>
        <div id="dependent-form-alert" class="alert hidden"></div>
        <div id="dependent-alert" class="alert hidden"></div>
      </div>
    </div>
    
    <!-- å®¢æˆ·ç®¡ç† -->
    <div id="customers" class="tab-content hidden">
      <div class="card">
        <h2>å®¢æˆ·åˆ—è¡¨</h2>
        <table id="customers-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>å§“å</th>
              <th>èº«ä»½è¯å·</th>
              <th>åŸå¸‚</th>
              <th>è¡—é“</th>
              <th>åŠ©ç†å‘˜å·¥ID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h2>æ·»åŠ å®¢æˆ·</h2>
        <form id="customer-form">
          <div class="form-group">
            <label>å§“å</label>
            <input type="text" name="name" required>
          </div>
          <div class="form-group">
            <label>èº«ä»½è¯å·</label>
            <input type="text" name="identity_no" required>
          </div>
          <div class="form-group">
            <label>åŸå¸‚</label>
            <input type="text" name="city" required>
          </div>
          <div class="form-group">
            <label>è¡—é“</label>
            <input type="text" name="street" required>
          </div>
          <div class="form-group">
            <label>åŠ©ç†å‘˜å·¥ID</label>
            <input type="number" name="assistant_employee_id">
          </div>
          <button type="submit" class="btn btn-primary">æ·»åŠ å®¢æˆ·</button>
        </form>
        <div id="customer-form-alert" class="alert hidden"></div>
        <div id="customer-alert" class="alert hidden"></div>
      </div>
    </div>
    
    <!-- è´¦æˆ·ç®¡ç† -->
    <div id="accounts" class="tab-content hidden">
      <div class="card">
        <h2>è´¦æˆ·åˆ—è¡¨</h2>
        <table id="accounts-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>è´¦æˆ·å·</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>ä½™é¢</th>
              <th>ç±»å‹</th>
              <th>åˆ©ç‡/é€æ”¯é¢åº¦</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h2>åˆ›å»ºè´¦æˆ·</h2>
        <form id="account-form">
          <div class="form-group">
            <label>è´¦æˆ·å·</label>
            <input type="text" name="account_no" required>
          </div>
          <div class="form-group">
            <label>ä½™é¢</label>
            <input type="number" name="balance" step="0.01" value="0">
          </div>
          <div class="form-group">
            <label>ç±»å‹</label>
            <select name="type" required>
              <option value="savings">å‚¨è“„è´¦æˆ·</option>
              <option value="checking">æ”¯ç¥¨è´¦æˆ·</option>
            </select>
          </div>
          <div class="form-group">
            <label>å®¢æˆ·ID</label>
            <input type="number" name="customer_id">
          </div>
          <div class="form-group savings-fields">
            <label>åˆ©ç‡</label>
            <input type="number" name="interest_rate" step="0.0001" value="0.02">
          </div>
          <div class="form-group checking-fields hidden">
            <label>é€æ”¯é¢åº¦</label>
            <input type="number" name="overdraft_limit" step="0.01" value="0">
          </div>
          <button type="submit" class="btn btn-primary">åˆ›å»ºè´¦æˆ·</button>
        </form>
        <div id="account-form-alert" class="alert hidden"></div>
        <div id="account-alert" class="alert hidden"></div>
      </div>
    </div>

    <!-- è´·æ¬¾ç®¡ç† -->
    <div id="loans" class="tab-content hidden">
      <div class="card">
        <h2>è´·æ¬¾åˆ—è¡¨</h2>
        <table id="loans-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>è´·æ¬¾å·</th>
              <th>é‡‘é¢</th>
              <th>å‘æ”¾åˆ†è¡ŒID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h2>åˆ›å»ºè´·æ¬¾</h2>
        <form id="loan-form">
          <div class="form-group">
            <label>è´·æ¬¾å·</label>
            <input type="text" name="loan_no" required>
          </div>
          <div class="form-group">
            <label>è´·æ¬¾é‡‘é¢</label>
            <input type="number" name="amount" step="0.01" min="0.01" required>
          </div>
          <div class="form-group">
            <label>å‘æ”¾åˆ†è¡ŒID</label>
            <input type="number" name="branch_id" required>
          </div>
          <div class="form-group">
            <label>å…³è”å®¢æˆ·IDåˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
            <input type="text" name="customer_ids" placeholder="å¦‚ï¼š1,2,3" required>
          </div>
          <button type="submit" class="btn btn-primary">åˆ›å»ºè´·æ¬¾</button>
        </form>
        <div id="loan-form-alert" class="alert hidden"></div>
        <div id="loan-alert" class="alert hidden"></div>
      </div>
    </div>
    
    <!-- å®¡æ‰¹ç®¡ç† -->
    <div id="approval" class="tab-content hidden">
      <div class="card">
        <h2>è´¦æˆ·æ³¨é”€ç”³è¯·å®¡æ‰¹</h2>
        <table id="approval-table">
          <thead>
            <tr>
              <th>ç”³è¯·ID</th>
              <th>å®¢æˆ·å§“å</th>
              <th>ç”³è¯·è¯¦æƒ…</th>
              <th>ç”³è¯·æ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h2>å®¡æ‰¹æ“ä½œ</h2>
        <form id="approval-form">
          <input type="hidden" id="approval-business-id">
          <div class="form-group">
            <label>å®¡æ‰¹æ„è§</label>
            <textarea id="approval-remark" placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§"></textarea>
          </div>
          <button type="button" class="btn btn-success" onclick="approveCloseAccount('APPROVE')">æ‰¹å‡†</button>
          <button type="button" class="btn btn-danger" onclick="approveCloseAccount('REJECT')">æ‹’ç»</button>
        </form>
        <div id="approval-alert" class="alert hidden"></div>
      </div>
    </div>
  </div>

  <script>
    let csrfToken
    let activeTab = 'dashboard'
    
    // è·å–CSRF Token
    async function getCsrf() {
      const r = await fetch('/csrf-token')
      const j = await r.json()
      csrfToken = j.token
    }
    
    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.add('hidden')
      })
      document.querySelectorAll('.nav a').forEach(el => {
        el.classList.remove('active')
      })
      document.getElementById(tabId).classList.remove('hidden')
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active')
      activeTab = tabId
      
      // åŠ è½½å¯¹åº”æ ‡ç­¾é¡µçš„æ•°æ®
      switch(tabId) {
        case 'dashboard':
          loadStats()
          break
        case 'branches':
          loadBranches()
          break
        case 'employees':
          loadEmployees()
          break
        case 'dependents':
          loadDependents()
          break
        case 'customers':
          loadCustomers()
          break
        case 'accounts':
          loadAccounts()
          break
        case 'loans':
          loadLoans()
          break
        case 'approval':
          loadPendingApprovals()
          break
      }
    }
    
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const [branchRes, empRes, custRes, accRes] = await Promise.all([
          fetch('/branches'),
          fetch('/employees'),
          fetch('/customers'),
          fetch('/accounts')
        ])
        
        const branches = await branchRes.json()
        const employees = await empRes.json()
        const customers = await custRes.json()
        const accounts = await accRes.json()
        
        document.getElementById('stats').innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px;">
            <div style="background: #ebf8ff; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #3182ce;">${branches.length}</div>
              <div style="color: #4a5568;">åˆ†è¡Œæ•°é‡</div>
            </div>
            <div style="background: #f0fff4; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #38a169;">${employees.length}</div>
              <div style="color: #4a5568;">å‘˜å·¥æ•°é‡</div>
            </div>
            <div style="background: #fffbeb; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #d69e2e;">${customers.length}</div>
              <div style="color: #4a5568;">å®¢æˆ·æ•°é‡</div>
            </div>
            <div style="background: #f7fafc; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #4a5568;">${accounts.length}</div>
              <div style="color: #4a5568;">è´¦æˆ·æ•°é‡</div>
            </div>
          </div>
        `
      } catch (e) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', e)
        showAlert('stats', 'åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + e.message, 'error')
      }
    }
    
    // åŠ è½½åˆ†è¡Œæ•°æ®
    async function loadBranches() {
      try {
        const r = await fetch('/branches')
        const branches = await r.json()
        const tbody = document.querySelector('#branches-table tbody')
        tbody.innerHTML = branches.map(b => `
          <tr>
            <td>${b.id}</td>
            <td>${b.union_no}</td>
            <td>${b.name}</td>
            <td>${b.city}</td>
          </tr>
        `).join('')
      } catch (e) {
        console.error('åŠ è½½åˆ†è¡Œæ•°æ®å¤±è´¥:', e)
        showAlert('branch', 'åŠ è½½åˆ†è¡Œæ•°æ®å¤±è´¥: ' + e.message, 'error')
      }
    }
    
    // åŠ è½½å‘˜å·¥æ•°æ®
    async function loadEmployees() {
      try {
        const r = await fetch('/employees')
        const employees = await r.json()
        const tbody = document.querySelector('#employees-table tbody')
        tbody.innerHTML = employees.map(e => `
          <tr>
            <td>${e.id}</td>
            <td>${e.name}</td>
            <td>${e.phone || ''}</td>
            <td>${e.hire_date}</td>
            <td>${e.manager_id || ''}</td>
          </tr>
        `).join('')
      } catch (e) {
        console.error('åŠ è½½å‘˜å·¥æ•°æ®å¤±è´¥:', e)
        showAlert('employee', 'åŠ è½½å‘˜å·¥æ•°æ®å¤±è´¥: ' + e.message, 'error')
      }
    }
    
    // åŠ è½½å®¶å±æ•°æ®
    async function loadDependents() {
      try {
        const r = await fetch('/dependents')
        if (!r.ok) {
          throw new Error(`HTTP error! status: ${r.status}`)
        }
        const dependents = await r.json()
        const tbody = document.querySelector('#dependents-table tbody')
        tbody.innerHTML = dependents.map(d => `
          <tr>
            <td>${d.id}</td>
            <td>${d.employee_id}</td>
            <td>${d.name}</td>
            <td>${d.relationship}</td>
          </tr>
        `).join('')
      } catch (e) {
        console.error('åŠ è½½å®¶å±æ•°æ®å¤±è´¥:', e)
        showAlert('dependent', 'åŠ è½½å®¶å±æ•°æ®å¤±è´¥: ' + (e.message || e), 'error')
      }
    }
    
    // åŠ è½½å®¢æˆ·æ•°æ®
    async function loadCustomers() {
      try {
        const r = await fetch('/customers')
        const customers = await r.json()
        const tbody = document.querySelector('#customers-table tbody')
        tbody.innerHTML = customers.map(c => `
          <tr>
            <td>${c.id}</td>
            <td>${c.name}</td>
            <td>${c.identity_no}</td>
            <td>${c.city}</td>
            <td>${c.street}</td>
            <td>${c.assistant_employee_id || ''}</td>
          </tr>
        `).join('')
      } catch (e) {
        console.error('åŠ è½½å®¢æˆ·æ•°æ®å¤±è´¥:', e)
        showAlert('customer', 'åŠ è½½å®¢æˆ·æ•°æ®å¤±è´¥: ' + e.message, 'error')
      }
    }
    
    // åŠ è½½è´¦æˆ·æ•°æ®
    async function loadAccounts() {
      try {
        const r = await fetch('/accounts')
        const accounts = await r.json()
        const tbody = document.querySelector('#accounts-table tbody')
        tbody.innerHTML = accounts.map(a => `
          <tr>
            <td>${a.id}</td>
            <td>${a.account_no}</td>
            <td>${new Date(a.created_at).toLocaleDateString()}</td>
            <td>Â¥${parseFloat(a.balance).toFixed(2)}</td>
            <td>${a.type}</td>
            <td>${a.type === 'savings' ? `åˆ©ç‡: ${(a.interest_rate * 100).toFixed(2)}%` : `é€æ”¯: Â¥${parseFloat(a.overdraft_limit || 0).toFixed(2)}`}</td>
          </tr>
        `).join('')
      } catch (e) {
        console.error('åŠ è½½è´¦æˆ·æ•°æ®å¤±è´¥:', e)
        showAlert('account', 'åŠ è½½è´¦æˆ·æ•°æ®å¤±è´¥: ' + e.message, 'error')
      }
    }

    // åŠ è½½è´·æ¬¾æ•°æ®
    async function loadLoans() {
      try {
        const r = await fetch('/loans')
        const loans = await r.json()
        const tbody = document.querySelector('#loans-table tbody')
        tbody.innerHTML = loans.map(l => `
          <tr>
            <td>${l.id}</td>
            <td>${l.loan_no}</td>
            <td>Â¥${parseFloat(l.amount).toFixed(2)}</td>
            <td>${l.branch_id}</td>
          </tr>
        `).join('')
      } catch (e) {
        console.error('åŠ è½½è´·æ¬¾æ•°æ®å¤±è´¥:', e)
        showAlert('loan', 'åŠ è½½è´·æ¬¾æ•°æ®å¤±è´¥: ' + e.message, 'error')
      }
    }
    
    // åŠ è½½å¾…å®¡æ‰¹æ•°æ®
    async function loadPendingApprovals() {
      try {
        const r = await fetch('/admin/pending-close-accounts')
        const approvals = await r.json()
        const tbody = document.querySelector('#approval-table tbody')
        tbody.innerHTML = approvals.map(a => `
          <tr>
            <td>${a.business_id}</td>
            <td>${a.customer_name}</td>
            <td>${a.remark}</td>
            <td>${new Date(a.created_at).toLocaleString()}</td>
            <td>
              <button class="btn btn-primary" onclick="selectApproval(${a.business_id})">å¤„ç†</button>
            </td>
          </tr>
        `).join('')
      } catch (e) {
        console.error('åŠ è½½å®¡æ‰¹æ•°æ®å¤±è´¥:', e)
        showAlert('approval', 'åŠ è½½å®¡æ‰¹æ•°æ®å¤±è´¥: ' + e.message, 'error')
      }
    }
    
    // é€‰æ‹©å®¡æ‰¹é¡¹
    function selectApproval(businessId) {
      document.getElementById('approval-business-id').value = businessId
      document.getElementById('approval-remark').value = ''
      document.getElementById('approval-alert').classList.add('hidden')
    }
    
    // å®¡æ‰¹è´¦æˆ·æ³¨é”€ç”³è¯·
    async function approveCloseAccount(action) {
      const businessId = document.getElementById('approval-business-id').value
      const remark = document.getElementById('approval-remark').value
      
      if (!businessId) {
        showAlert('approval', 'è¯·é€‰æ‹©è¦å¤„ç†çš„ç”³è¯·', 'error')
        return
      }
      
      try {
        const r = await fetch('/admin/approve-close-account', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify({ business_id: businessId, action: action, remark: remark })
        })
        
        const j = await r.json()
        if (r.ok) {
          showAlert('approval', j.message, 'success')
          loadPendingApprovals()
          // 3ç§’åæ¸…é™¤æˆåŠŸæ¶ˆæ¯
          setTimeout(() => {
            document.getElementById('approval-alert').classList.add('hidden');
            document.getElementById('approval-alert').classList.remove('fade-out');
          }, 3000);
        } else {
          showAlert('approval', j.error, 'error')
        }
      } catch (e) {
        showAlert('approval', 'å®¡æ‰¹å¤±è´¥: ' + e.message, 'error')
      }
    }
    
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showAlert(formId, message, type) {
      const alertEl = document.getElementById(`${formId}-alert`)
      if (!alertEl) {
        console.error('æ‰¾ä¸åˆ°æç¤ºå…ƒç´ :', `${formId}-alert`)
        return
      }
      
      alertEl.className = `alert alert-${type}`
      alertEl.textContent = message
      alertEl.classList.remove('hidden')
      alertEl.classList.remove('fade-out')
      
      // æˆåŠŸæ¶ˆæ¯3ç§’åæ·¡å‡º
      if (type === 'success') {
        setTimeout(() => {
          alertEl.classList.add('fade-out')
          setTimeout(() => {
            alertEl.classList.add('hidden')
          }, 500)
        }, 3000)
      }
    }
    
    // è¡¨å•æäº¤å¤„ç†
    async function handleSubmit(formId, url, successMsg) {
      const form = document.getElementById(formId)
      const formData = new FormData(form)
      const data = {}
      const fields = Array.from(form.elements).filter(el => el.name)
      for (let [key, value] of formData.entries()) {
        if (value !== '') {
          const el = fields.find(e => e.name === key)
          if (el && el.type === 'number') {
            data[key] = value.includes('.') ? parseFloat(value) : parseInt(value)
          } else {
            data[key] = value
          }
        }
      }

      // ç‰¹æ®Šå­—æ®µå¤„ç†ï¼šé€—å·åˆ†éš”çš„å®¢æˆ·IDåˆ—è¡¨
      if (typeof data.customer_ids === 'string') {
        data.customer_ids = data.customer_ids
          .split(',')
          .map(s => s.trim())
          .filter(s => s.length > 0)
          .map(s => parseInt(s))
          .filter(n => !Number.isNaN(n))
      }
      
      try {
        const r = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify(data)
        })
        
        const j = await r.json()
        if (r.ok) {
          showAlert(formId, successMsg, 'success')
          form.reset()
          // é‡æ–°åŠ è½½å¯¹åº”çš„æ•°æ®
          switch(formId) {
            case 'branch-form':
              loadBranches()
              break
            case 'employee-form':
              loadEmployees()
              break
            case 'dependent-form':
              loadDependents()
              break
            case 'customer-form':
              loadCustomers()
              break
            case 'account-form':
              loadAccounts()
              break
            case 'loan-form':
              loadLoans()
              break
          }
        } else {
          showAlert(formId, j.error || 'æ“ä½œå¤±è´¥', 'error')
        }
      } catch (e) {
        showAlert(formId, 'æ“ä½œå¤±è´¥: ' + e.message, 'error')
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      await getCsrf()
      loadStats()
      
      // ç»‘å®šå¯¼èˆªç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.nav a[data-tab]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault()
          switchTab(e.target.dataset.tab)
        })
      })
      
      // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
      document.getElementById('branch-form').addEventListener('submit', (e) => {
        e.preventDefault()
        handleSubmit('branch-form', '/branches', 'åˆ†è¡Œæ·»åŠ æˆåŠŸ')
      })
      
      document.getElementById('employee-form').addEventListener('submit', (e) => {
        e.preventDefault()
        handleSubmit('employee-form', '/employees', 'å‘˜å·¥æ·»åŠ æˆåŠŸ')
      })
      
      document.getElementById('dependent-form').addEventListener('submit', (e) => {
        e.preventDefault()
        handleSubmit('dependent-form', '/dependents', 'å®¶å±æ·»åŠ æˆåŠŸ')
      })
      
      document.getElementById('customer-form').addEventListener('submit', (e) => {
        e.preventDefault()
        handleSubmit('customer-form', '/customers', 'å®¢æˆ·æ·»åŠ æˆåŠŸ')
      })
      
      document.getElementById('account-form').addEventListener('submit', (e) => {
        e.preventDefault()
        handleSubmit('account-form', '/accounts', 'è´¦æˆ·åˆ›å»ºæˆåŠŸ')
      })

      document.getElementById('loan-form').addEventListener('submit', (e) => {
        e.preventDefault()
        handleSubmit('loan-form', '/loans', 'è´·æ¬¾åˆ›å»ºæˆåŠŸ')
      })
      
      // è´¦æˆ·ç±»å‹åˆ‡æ¢
      document.querySelector('[name="type"]').addEventListener('change', (e) => {
        if (e.target.value === 'savings') {
          document.querySelector('.savings-fields').classList.remove('hidden')
          document.querySelector('.checking-fields').classList.add('hidden')
        } else {
          document.querySelector('.savings-fields').classList.add('hidden')
          document.querySelector('.checking-fields').classList.remove('hidden')
        }
      })
    })
  </script>
</body>
</html>
