<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è´·æ¬¾æŸ¥è¯¢</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; background:#f5f7fa; margin:0 }
    .header { background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.1); padding:16px 24px; display:flex; justify-content:space-between; align-items:center }
    .logo { font-weight:700; color:#2d3748 }
    .container { max-width:1000px; margin:24px auto; padding:0 24px }
    .card { background:#fff; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.1); padding:24px; margin-bottom:24px }
    .form-group { margin-bottom:16px }
    label { display:block; margin-bottom:8px; color:#4a5568 }
    input { width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:6px; font-size:16px }
    .btn { padding:8px 16px; border-radius:6px; border:none; background:#4299e1; color:#fff; cursor:pointer }
    table { width:100%; border-collapse:collapse }
    th,td { text-align:left; padding:12px; border-bottom:1px solid #e2e8f0 }
    th { background:#f7fafc; color:#4a5568 }
    .alert { padding:12px; border-radius:6px; margin:16px 0 }
    .alert-error { background:#fed7d7; color:#742a2a; border:1px solid #feb2b2 }
    .highlight { font-weight:700; color:#2b6cb0 }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">ğŸ¦ è´·æ¬¾æŸ¥è¯¢</div>
    <div><a class="btn" href="/admin">è¿”å›ä»ªè¡¨ç›˜</a></div>
  </div>
  <div class="container">
    <div class="card">
      <div class="form-group">
        <label>è´·æ¬¾å·</label>
        <input id="loan_no" placeholder="è¯·è¾“å…¥è´·æ¬¾å·">
      </div>
      <div class="form-group">
        <label><input type="checkbox" id="fuzzy"> æ¨¡ç³ŠæŸ¥è¯¢</label>
      </div>
      <button class="btn" onclick="doQuery()">æŸ¥è¯¢</button>
      <div id="err" class="alert alert-error" style="display:none"></div>
    </div>
    <div class="card">
      <table id="result"><thead></thead><tbody></tbody></table>
    </div>
  </div>
  <script>
    async function doQuery(){
      const n = document.getElementById('loan_no').value.trim()
      const f = document.getElementById('fuzzy').checked
      if(!n){ showErr('è¯·å¡«å†™è´·æ¬¾å·'); return }
      const url = '/admin/api/query/loan?loan_no=' + encodeURIComponent(n) + (f?'&fuzzy=1':'')
      const r = await fetch(url)
      const j = await r.json()
      if(!r.ok){ showErr(j.error||'æŸ¥è¯¢å¤±è´¥'); return }
      render(j, f)
    }
    function showErr(msg){ const el = document.getElementById('err'); el.textContent=msg; el.style.display='block' }
    function render(data, isList){
      const t = document.getElementById('result')
      const thead = '<tr><th class="highlight">è´·æ¬¾å·</th><th>è´·æ¬¾é‡‘é¢</th><th>å‘æ”¾æ”¯è¡Œè”è¡Œå·</th><th>å®¢æˆ·åˆ—è¡¨</th><th>å·²è¿˜æ¬¾é‡‘é¢</th><th>å‰©ä½™é‡‘é¢</th><th>æ“ä½œ</th></tr>'
      const list = isList ? data : [data]
      const rows = list.map(r => `<tr><td class="highlight">${r.loan_no||''}</td><td>${r.amount!=null?('Â¥'+Number(r.amount).toFixed(2)):''}</td><td>${r.branch_union_no||''}</td><td>${(r.customers||[]).join(', ')}</td><td>${r.paid_amount!=null?('Â¥'+Number(r.paid_amount).toFixed(2)):''}</td><td>${r.remaining_amount!=null?('Â¥'+Number(r.remaining_amount).toFixed(2)):''}</td><td><span class='delete-container' data-id='${r.id||''}' data-endpoint='/admin/loans/delete'></span></td></tr>`)
      t.querySelector('thead').innerHTML = thead
      t.querySelector('tbody').innerHTML = rows.join('')
      document.getElementById('err').style.display='none'
      mountDeleteButtons('#result', '/admin/loans/delete')
    }
    let csrfToken
    async function getCsrf(){ const r = await fetch('/csrf-token'); const j = await r.json(); csrfToken = j.token }
    function mountDeleteButtons(tableSelector, endpoint){
      const containers = document.querySelectorAll(`${tableSelector} .delete-container`)
      containers.forEach(el => {
        const id = el.dataset.id
        const app = Vue.createApp({
          data(){ return { loading:false } },
          methods:{
            async onDelete(){
              if(!id) return
              if(!confirm('ç¡®è®¤åˆ é™¤è¯¥è®°å½•ï¼Ÿ')) return
              this.loading = true
              try {
                const sr = await fetch('/admin/sensitive/start', { method:'POST', headers:{ 'X-CSRF-Token': csrfToken } })
                const sj = await sr.json()
                if(!sr.ok) throw new Error(sj.error||'æ— æ³•è·å–æˆæƒç ')
                const code = sj.code
                const r = await fetch(endpoint, { method:'POST', headers:{ 'Content-Type':'application/json','X-CSRF-Token': csrfToken }, body: JSON.stringify({ id: parseInt(id), confirm: true, code }) })
                const ct = (r.headers.get('content-type')||'')
                let j = null
                if (ct.includes('application/json')) j = await r.json()
                else {
                  const t = await r.text()
                  if (!r.ok) throw new Error(t)
                }
                if(!r.ok) throw new Error((j && j.error) || 'åˆ é™¤å¤±è´¥')
                const tbody = document.querySelector(`${tableSelector} tbody`)
                if (tbody) el.closest('tr').remove()
              } catch(e){ alert(`åˆ é™¤å¤±è´¥: ${e.message||e}`) }
              finally { this.loading=false }
            }
          },
          template:`<button class='btn' :disabled='loading' @click='onDelete'>{{ loading?"åˆ é™¤ä¸­...":"åˆ é™¤" }}</button>`
        })
        app.mount(el)
      })
    }
    document.addEventListener('DOMContentLoaded', getCsrf)
  </script>
</body>
</html>
