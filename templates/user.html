<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>个人中心</title>
  <style>
    :root { --bg:#111827; --accent:#10b981; --card:#0b1222; --text:#e5e7eb; --muted:#94a3b8; }
    body { margin:0; background: radial-gradient(900px 500px at 30% 0%, #0b1222 0%, #111827 35%, #0a0f1f 100%); color: var(--text); font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; }
    .hero { background: linear-gradient(135deg, rgba(16,185,129,.18), rgba(14,165,233,.18)); border-bottom: 1px solid rgba(148,163,184,.15); }
    .hero-inner { max-width: 1100px; margin: 0 auto; padding: 24px; display:flex; align-items:center; justify-content:space-between; }
    .brand { display:flex; align-items:center; gap:12px; font-weight:700; font-size:22px; }
    .brand-badge { width:40px; height:40px; border-radius:12px; background: linear-gradient(135deg, var(--accent), #34d399); display:flex; align-items:center; justify-content:center; color:#fff; }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    .grid { display:grid; grid-template-columns: .9fr 1.1fr; gap:18px; }
    .card { background: linear-gradient(180deg, rgba(11,18,34,.9), rgba(11,18,34,.6)); border: 1px solid rgba(148,163,184,.12); border-radius:16px; padding:16px; }
    h3 { margin:0 0 10px; font-size:16px; color:#cbd5e1; }
    .status { font-size:13px; color:#cbd5e1; }
    label { font-size:13px; color:#94a3b8; display:block; margin-bottom:10px; }
    input { width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.22); background:#0b1222; color:var(--text); outline:none; margin-top:6px; }
    input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(16,185,129,.2); }
    .actions { margin-top:12px; display:flex; gap:10px; }
    .btn { appearance:none; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; }
    .btn-primary { background: linear-gradient(135deg, var(--accent), #34d399); color:#fff; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid rgba(148,163,184,.1); padding:10px; text-align:left; font-size:13px; }
  </style>
  <script>
    let csrfToken
    async function getCsrf() { const r = await fetch('/csrf-token'); const j = await r.json(); csrfToken = j.token }
    async function loadMe() { const r = await fetch('/me'); const j = await r.json(); renderMe(j) }
    async function loadHistory() { const r = await fetch('/user/history'); const j = await r.json(); renderHistory(j) }
    function renderMe(m) {
      const el = document.getElementById('me')
      el.innerHTML = `<div>用户名：<b>${m.username}</b></div><div>角色：<b>${m.role}</b></div><div>注册时间：<b>${m.created_at || ''}</b></div><div>最近登录：<b>${m.last_login_at || ''}</b></div>`
    }
    function renderHistory(rows) {
      const el = document.getElementById('hist_tbl')
      if (!rows.length) { el.innerHTML = '<thead><tr><th>无记录</th></tr></thead>'; return }
      const thead = '<thead><tr><th>动作</th><th>时间</th></tr></thead>'
      const tbody = '<tbody>' + rows.map(r => `<tr><td>${r.action}</td><td>${r.created_at}</td></tr>`).join('') + '</tbody>'
      el.innerHTML = thead + tbody
    }
    async function changePwd(e) {
      e.preventDefault()
      const o = document.getElementById('old').value
      const n = document.getElementById('new').value
      if (!o || !n || n.length < 6) { setStatus('pwd_status', false, '请填写旧密码和长度≥6的新密码'); return }
      const r = await fetch('/user/change-password', { method:'POST', headers:{ 'Content-Type':'application/json','X-CSRF-Token': csrfToken }, body: JSON.stringify({ old_password: o, new_password: n }) })
      const j = await r.json()
      setStatus('pwd_status', r.status === 200, r.status === 200 ? '密码已更新' : '更新失败：' + (j.error || '未知错误'))
    }
    function setStatus(id, ok, msg) { const el = document.getElementById(id); el.textContent = msg; el.className = 'status ' + (ok ? '' : '') }
    window.addEventListener('load', async () => { await getCsrf(); loadMe(); loadHistory() })
  </script>
</head>
<body>
  <div class="hero"><div class="hero-inner"><div class="brand"><div class="brand-badge">个</div>个人中心</div><div><a class="btn btn-primary" href="/login">退出登录</a></div></div></div>
  <div class="container">
    <div class="grid">
      <div class="card"><h3>基本信息</h3><div id="me" class="status"></div></div>
      <div class="card"><h3>账户设置</h3>
        <form onsubmit="changePwd(event)">
          <label>旧密码<input id="old" type="password" required></label>
          <label>新密码<input id="new" type="password" required></label>
          <div class="actions"><button class="btn btn-primary" type="submit">更新密码</button></div>
          <div id="pwd_status" class="status"></div>
        </form>
      </div>
    </div>
    <div class="card" style="margin-top:18px"><h3>操作历史记录</h3><table id="hist_tbl"></table></div>
  </div>
</body>
</html>
