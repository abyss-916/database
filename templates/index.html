<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>银行数据库系统</title>
  <style>
    :root { --bg:#0f172a; --primary:#2563eb; --primary-2:#1d4ed8; --card:#0b1222; --text:#e5e7eb; --muted:#94a3b8; --success:#10b981; --error:#ef4444; --border:#1f2937; }
    * { box-sizing: border-box; }
    body { margin:0; background: radial-gradient(1100px 600px at 10% 10%, #0b1222 0%, #0f172a 35%, #0a0f1f 100%); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .hero { background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(29,78,216,.18)); border-bottom: 1px solid rgba(148,163,184,.15); }
    .hero-inner { max-width: 1200px; margin: 0 auto; padding: 28px 24px; display:flex; align-items:center; justify-content:space-between; }
    .brand { display:flex; align-items:center; gap:12px; font-weight:700; font-size:22px; letter-spacing:.3px; }
    .brand-badge { width:40px; height:40px; border-radius:12px; background: linear-gradient(135deg, var(--primary), var(--primary-2)); display:flex; align-items:center; justify-content:center; color:#fff; }
    .actions { display:flex; gap:10px; }
    .btn { appearance:none; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; transition: all .18s ease; }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-2)); color:#fff; }
    .btn-primary:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .btn-muted { background: rgba(148,163,184,.15); color: var(--text); }
    .btn-muted:hover { background: rgba(148,163,184,.25); }
    .grid-cards { display:grid; grid-template-columns: repeat(3,1fr); gap:18px; margin-top:18px; }
    .card { background: linear-gradient(180deg, rgba(11,18,34,.9), rgba(11,18,34,.6)); border: 1px solid rgba(148,163,184,.12); border-radius:16px; padding:16px; backdrop-filter: blur(6px); }
    .card h3 { margin:0 0 8px; font-size:16px; color:#cbd5e1; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; font-size:13px; }
    .pill-ok { background: rgba(16,185,129,.15); color:#34d399; border:1px solid rgba(16,185,129,.35); }
    .pill-err { background: rgba(239,68,68,.15); color:#fca5a5; border:1px solid rgba(239,68,68,.35); }
    .tabs { display:flex; gap:10px; margin-top:22px; }
    .tab { padding:10px 14px; border-radius:12px; background: rgba(148,163,184,.12); color:#cbd5e1; cursor:pointer; font-weight:600; transition:.18s; }
    .tab.active { background: linear-gradient(135deg, rgba(37,99,235,.35), rgba(29,78,216,.35)); color:#fff; }
    .panels { margin-top:18px; }
    .panel { display:none; }
    .panel.active { display:block; }
    .panel-grid { display:grid; grid-template-columns: 1.1fr .9fr; gap:18px; }
    form { background: linear-gradient(180deg, rgba(12,20,36,.9), rgba(12,20,36,.6)); border: 1px solid rgba(148,163,184,.12); border-radius:16px; padding:16px; }
    .form-row { display:grid; grid-template-columns: repeat(2, minmax(240px,1fr)); gap:12px; }
    label { font-size:13px; color:#94a3b8; }
    input, select { width:100%; margin-top:6px; padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.22); background:#0b1222; color:var(--text); outline:none; transition:.16s; }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,.2); }
    .form-actions { margin-top:12px; display:flex; gap:10px; }
    .status { margin-top:8px; font-size:13px; color:#cbd5e1; }
    .table-card { background: linear-gradient(180deg, rgba(11,18,34,.9), rgba(11,18,34,.6)); border: 1px solid rgba(148,163,184,.12); border-radius:16px; padding:12px; }
    table { width:100%; border-collapse: collapse; }
    thead th { position:sticky; top:0; background: rgba(2,8,23,.8); color:#cbd5e1; font-weight:600; }
    th, td { border-bottom:1px solid rgba(148,163,184,.1); padding:10px; text-align:left; font-size:13px; }
    tbody tr:hover { background: rgba(148,163,184,.08); }
    .hidden { display:none; }
    .toast { position: fixed; left:50%; transform: translateX(-50%); bottom:24px; background: #0b1222; color:#fff; border:1px solid rgba(148,163,184,.2); border-radius:999px; padding:10px 16px; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:9999; opacity:0; pointer-events:none; transition:.22s; }
    .toast.show { opacity:1; pointer-events:auto; }
  </style>
  <script>
    let activeTab = 'branches'
    let toastTimer
    async function api(path, method, body) {
      const res = await fetch(path, { method, headers: { 'Content-Type': 'application/json' }, body: body ? JSON.stringify(body) : undefined })
      const json = await res.json()
      return { status: res.status, json }
    }
    function toast(msg) {
      const el = document.getElementById('toast')
      el.textContent = msg
      el.classList.add('show')
      clearTimeout(toastTimer)
      toastTimer = setTimeout(() => el.classList.remove('show'), 2200)
    }
    function setStatus(id, ok, msg) {
      const el = document.getElementById(id)
      el.textContent = msg
      el.className = 'status ' + (ok ? 'pill-ok' : 'pill-err')
      toast(msg)
    }
    function activateTab(name) {
      activeTab = name
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name))
      document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + name))
    }
    async function loadConfig() {
      const r = await fetch('/db-config')
      const j = await r.json()
      const el = document.getElementById('cfg')
      el.innerHTML = `连接配置：<b>${j.host}:${j.port}</b> / <b>${j.database}</b> / <b>${j.user}</b> / 密码${j.has_password ? '已设置' : '未设置'}`
    }
    async function initDb() {
      const r = await api('/init-db', 'POST')
      setStatus('initStatus', r.status === 200, r.status === 200 ? '初始化完成' : '初始化失败: ' + r.json.error)
    }
    async function health() {
      const r = await fetch('/health')
      const j = await r.json()
      const el = document.getElementById('health')
      el.textContent = j.ok ? '数据库连接正常' : '数据库连接失败: ' + j.error
      el.className = 'pill ' + (j.ok ? 'pill-ok' : 'pill-err')
      toast(el.textContent)
    }
    async function submitBranch(e) {
      e.preventDefault()
      const union_no = document.getElementById('b_union').value
      const name = document.getElementById('b_name').value
      const city = document.getElementById('b_city').value
      const r = await api('/branches', 'POST', { union_no, name, city })
      setStatus('b_status', r.status === 200, r.status === 200 ? '支行已创建' : r.json.error)
      loadBranches()
    }
    async function submitEmployee(e) {
      e.preventDefault()
      const name = document.getElementById('e_name').value
      const phone = document.getElementById('e_phone').value
      const hire_date = document.getElementById('e_hire_date').value
      const manager_id = document.getElementById('e_manager_id').value || null
      const r = await api('/employees', 'POST', { name, phone, hire_date, manager_id })
      setStatus('e_status', r.status === 200, r.status === 200 ? '员工已创建' : r.json.error)
      loadEmployees()
    }
    async function submitDependent(e) {
      e.preventDefault()
      const employee_id = document.getElementById('d_emp_id').value
      const name = document.getElementById('d_name').value
      const relationship = document.getElementById('d_rel').value
      const r = await api('/dependents', 'POST', { employee_id, name, relationship })
      setStatus('d_status', r.status === 200, r.status === 200 ? '家属已添加' : r.json.error)
    }
    async function submitCustomer(e) {
      e.preventDefault()
      const name = document.getElementById('c_name').value
      const identity_no = document.getElementById('c_idno').value
      const city = document.getElementById('c_city').value
      const street = document.getElementById('c_street').value
      const assistant_employee_id = document.getElementById('c_assist').value || null
      const r = await api('/customers', 'POST', { name, identity_no, city, street, assistant_employee_id })
      setStatus('c_status', r.status === 200, r.status === 200 ? '客户已创建' : r.json.error)
      loadCustomers()
    }
    function showTypeFields() {
      const type = document.getElementById('a_type').value
      document.getElementById('savings_fields').style.display = type === 'savings' ? 'grid' : 'none'
      document.getElementById('checking_fields').style.display = type === 'checking' ? 'grid' : 'none'
    }
    async function submitAccount(e) {
      e.preventDefault()
      const account_no = document.getElementById('a_no').value
      const balance = document.getElementById('a_bal').value
      const type = document.getElementById('a_type').value
      const customer_id = document.getElementById('a_owner').value || null
      const body = { account_no, balance, type, customer_id }
      if (type === 'savings') body.interest_rate = document.getElementById('a_rate').value
      if (type === 'checking') body.overdraft_limit = document.getElementById('a_od').value
      const r = await api('/accounts', 'POST', body)
      setStatus('a_status', r.status === 200, r.status === 200 ? '账户已创建' : r.json.error)
      loadAccounts()
    }
    async function submitAccountOwner(e) {
      e.preventDefault()
      const account_id = document.getElementById('ao_account').value
      const customer_id = document.getElementById('ao_cust').value
      const r = await api('/account_owners', 'POST', { account_id, customer_id })
      setStatus('ao_status', r.status === 200, r.status === 200 ? '账户所有者已添加' : r.json.error)
    }
    async function submitLoan(e) {
      e.preventDefault()
      const loan_no = document.getElementById('l_no').value
      const amount = document.getElementById('l_amt').value
      const branch_id = document.getElementById('l_branch').value
      const ids = document.getElementById('l_custs').value
      const customer_ids = ids ? ids.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x)) : []
      const r = await api('/loans', 'POST', { loan_no, amount, branch_id, customer_ids })
      setStatus('l_status', r.status === 200, r.status === 200 ? '贷款已创建' : r.json.error)
      loadLoans()
    }
    async function submitRepayment(e) {
      e.preventDefault()
      const loan_id = document.getElementById('r_loan').value
      const batch_no = document.getElementById('r_batch').value
      const paid_at = document.getElementById('r_date').value
      const amount = document.getElementById('r_amt').value
      const savings_account_id = document.getElementById('r_sa').value
      const r = await api('/repayments', 'POST', { loan_id, batch_no, paid_at, amount, savings_account_id })
      setStatus('r_status', r.status === 200, r.status === 200 ? '还款已记录' : r.json.error)
      loadRepayments()
    }
    async function loadBranches() { const r = await fetch('/branches'); renderTable('branches_tbl', await r.json()) }
    async function loadEmployees() { const r = await fetch('/employees'); renderTable('employees_tbl', await r.json()) }
    async function loadCustomers() { const r = await fetch('/customers'); renderTable('customers_tbl', await r.json()) }
    async function loadAccounts() { const r = await fetch('/accounts'); renderTable('accounts_tbl', await r.json()) }
    async function loadLoans() { const r = await fetch('/loans'); renderTable('loans_tbl', await r.json()) }
    async function loadRepayments() { const r = await fetch('/repayments'); renderTable('repayments_tbl', await r.json()) }
    function renderTable(id, rows) {
      const el = document.getElementById(id)
      if (!rows.length) { el.innerHTML = '<thead><tr><th>无数据</th></tr></thead>'; return }
      const keys = Object.keys(rows[0])
      const thead = '<thead><tr>' + keys.map(k => '<th>' + k + '</th>').join('') + '</tr></thead>'
      const tbody = '<tbody>' + rows.map(r => '<tr>' + keys.map(k => '<td>' + (r[k] ?? '') + '</td>').join('') + '</tr>').join('') + '</tbody>'
      el.innerHTML = thead + tbody
    }
    window.addEventListener('load', () => {
      health(); loadConfig(); activateTab('branches')
      loadBranches(); loadEmployees(); loadCustomers(); loadAccounts(); loadLoans(); loadRepayments(); showTypeFields()
      document.querySelectorAll('.tab').forEach(btn => btn.addEventListener('click', () => activateTab(btn.dataset.tab)))
      document.getElementById('branch_form').addEventListener('submit', submitBranch)
      document.getElementById('emp_form').addEventListener('submit', submitEmployee)
      document.getElementById('dep_form').addEventListener('submit', submitDependent)
      document.getElementById('cust_form').addEventListener('submit', submitCustomer)
      document.getElementById('account_form').addEventListener('submit', submitAccount)
      document.getElementById('ao_form').addEventListener('submit', submitAccountOwner)
      document.getElementById('loan_form').addEventListener('submit', submitLoan)
      document.getElementById('repay_form').addEventListener('submit', submitRepayment)
    })
  </script>
</head>
<body>
  <div class="hero">
    <div class="hero-inner">
      <div class="brand"><div class="brand-badge">银</div>银行数据库系统</div>
      <div class="actions">
        <button class="btn btn-primary" onclick="initDb()">初始化数据库</button>
        <button class="btn btn-muted" onclick="health()">检查连接</button>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="grid-cards">
      <div class="card"><h3>连接配置</h3><div id="cfg" class="status"></div></div>
      <div class="card"><h3>连接状态</h3><div id="health" class="pill"></div><div id="initStatus" class="status"></div></div>
      <div class="card"><h3>说明</h3><div class="status">已使用本地配置文件 config.local.json 读取数据库连接信息。</div></div>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="branches">支行</div>
      <div class="tab" data-tab="employees">员工与家属</div>
      <div class="tab" data-tab="customers">客户</div>
      <div class="tab" data-tab="accounts">账户</div>
      <div class="tab" data-tab="loans">贷款</div>
      <div class="tab" data-tab="repayments">还款</div>
    </div>
    <div class="panels">
      <div class="panel panel-grid active" id="panel-branches">
        <form id="branch_form">
          <div class="form-row">
            <div><label>联行号<input id="b_union" required></label></div>
            <div><label>名称<input id="b_name" required></label></div>
            <div><label>城市<input id="b_city" required></label></div>
          </div>
          <div class="form-actions"><button class="btn btn-primary" type="submit">创建支行</button></div>
          <div id="b_status" class="status"></div>
        </form>
        <div class="table-card"><table id="branches_tbl"></table></div>
      </div>
      <div class="panel panel-grid" id="panel-employees">
        <form id="emp_form">
          <div class="form-row">
            <div><label>姓名<input id="e_name" required></label></div>
            <div><label>电话<input id="e_phone"></label></div>
            <div><label>入职日期<input id="e_hire_date" type="date" required></label></div>
            <div><label>经理ID<input id="e_manager_id" type="number"></label></div>
          </div>
          <div class="form-actions"><button class="btn btn-primary" type="submit">创建员工</button></div>
          <div id="e_status" class="status"></div>
        </form>
        <form id="dep_form">
          <div class="form-row">
            <div><label>员工ID<input id="d_emp_id" type="number" required></label></div>
            <div><label>家属姓名<input id="d_name" required></label></div>
            <div><label>关系<input id="d_rel" required></label></div>
          </div>
          <div class="form-actions"><button class="btn btn-primary" type="submit">添加家属</button></div>
          <div id="d_status" class="status"></div>
        </form>
        <div class="table-card"><table id="employees_tbl"></table></div>
      </div>
      <div class="panel panel-grid" id="panel-customers">
        <form id="cust_form">
          <div class="form-row">
            <div><label>姓名<input id="c_name" required></label></div>
            <div><label>证件号<input id="c_idno" required></label></div>
            <div><label>城市<input id="c_city" required></label></div>
            <div><label>街道<input id="c_street" required></label></div>
            <div><label>私人助理员工ID<input id="c_assist" type="number"></label></div>
          </div>
          <div class="form-actions"><button class="btn btn-primary" type="submit">创建客户</button></div>
          <div id="c_status" class="status"></div>
        </form>
        <div class="table-card"><table id="customers_tbl"></table></div>
      </div>
      <div class="panel panel-grid" id="panel-accounts">
        <form id="account_form">
          <div class="form-row">
            <div><label>账户号<input id="a_no" required></label></div>
            <div><label>初始余额<input id="a_bal" type="number" value="0"></label></div>
            <div><label>类型<select id="a_type" onchange="showTypeFields()"><option value="savings">储蓄</option><option value="checking">支票</option></select></label></div>
          </div>
          <div class="form-row" id="savings_fields">
            <div><label>利率<input id="a_rate" type="number" step="0.0001" value="0.01"></label></div>
          </div>
          <div class="form-row" id="checking_fields" style="display:none">
            <div><label>可透支额度<input id="a_od" type="number" value="0"></label></div>
          </div>
          <div class="form-row">
            <div><label>初始所有者客户ID<input id="a_owner" type="number"></label></div>
          </div>
          <div class="form-actions"><button class="btn btn-primary" type="submit">创建账户</button></div>
          <div id="a_status" class="status"></div>
        </form>
        <form id="ao_form">
          <div class="form-row">
            <div><label>账户ID<input id="ao_account" type="number" required></label></div>
            <div><label>客户ID<input id="ao_cust" type="number" required></label></div>
          </div>
          <div class="form-actions"><button class="btn btn-primary" type="submit">添加账户所有者</button></div>
          <div id="ao_status" class="status"></div>
        </form>
        <div class="table-card"><table id="accounts_tbl"></table></div>
      </div>
      <div class="panel panel-grid" id="panel-loans">
        <form id="loan_form">
          <div class="form-row">
            <div><label>贷款号<input id="l_no" required></label></div>
            <div><label>金额<input id="l_amt" type="number" required></label></div>
            <div><label>发放支行ID<input id="l_branch" type="number" required></label></div>
            <div><label>所有者客户ID列表(逗号分隔)<input id="l_custs"></label></div>
          </div>
          <div class="form-actions"><button class="btn btn-primary" type="submit">创建贷款</button></div>
          <div id="l_status" class="status"></div>
        </form>
        <div class="table-card"><table id="loans_tbl"></table></div>
      </div>
      <div class="panel panel-grid" id="panel-repayments">
        <form id="repay_form">
          <div class="form-row">
            <div><label>贷款ID<input id="r_loan" type="number" required></label></div>
            <div><label>批次<input id="r_batch" type="number" required></label></div>
            <div><label>日期<input id="r_date" type="date" required></label></div>
            <div><label>金额<input id="r_amt" type="number" required></label></div>
            <div><label>储蓄账户ID<input id="r_sa" type="number" required></label></div>
          </div>
          <div class="form-actions"><button class="btn btn-primary" type="submit">记录还款</button></div>
          <div id="r_status" class="status"></div>
        </form>
        <div class="table-card"><table id="repayments_tbl"></table></div>
      </div>
    </div>
  </div>
  <div id="toast" class="toast"></div>
</body>
</html>
